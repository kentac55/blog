import Layout from 'lib/components/layout'
import { Image } from '@zeit-ui/react'

export const meta = {
  title: 'ãŠã†ã¡ã‚¤ãƒ³ãƒ•ãƒ©_ä»®æƒ³åŸºç›¤NWç·¨',
  date: '2020-05-24T18:16:12.106929675+09:00',
  description: 'è‡ªå®…ã®ä»®æƒ³åŸºç›¤ã‚’Open vSwitch, NetworkManager, libvirtã‚’ä½¿ã£ã¦æ§‹ç¯‰ã™ã‚‹',
  image: '',
  tags: 'ãŠã†ã¡ã‚¤ãƒ³ãƒ•ãƒ©,linux,network'
}

è‡ªå®…ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã®ãƒ¡ãƒ¢ã€‚

ä»Šå›ã¯ä»®æƒ³åŸºç›¤ã®NWæ§‹ç¯‰ã«ã¤ã„ã¦ã€‚

## ç’°å¢ƒ

å…¨ä½“å›³ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

<Image width="1095" height="638" alt="å…¨ä½“å›³" src="/images/20200524_190633.png" />

ä»Šå›ã¯è–„é»„è‰²ã®ä¸¸ã§è¦†ã‚ã‚Œã¦ã„ã‚‹éƒ¨åˆ†ã«ã¤ã„ã¦ã®ãƒ¡ãƒ¢ã€‚

KVMã®ãƒã‚·ãƒ³ã¯æ•°å¹´å‰ã«çµ„ã‚“ã Ryzen Tyreadripper 1950X + X399Taichiã®ãƒã‚·ãƒ³ã€‚

ç‰¹ã«ã“ã®ãƒã‚¶ãƒœãã‚“ã€nvmeã‚’3æšåˆºã›ã‚‹ã—I211ç‰©ç†NICãŒ2ã¤ã‚ã‚‹ã—ãƒ¡ãƒ¢ãƒª256GBã¾ã§ã„ã‘ã‚‹ã€‚ã»ã‚“ã¨ç¥ã€‚

OSã¯fedora 32ã€‚

## ã„ã–æ§‹ç¯‰

### äº‹å‰æº–å‚™

ã¾ãšå¯¾å‘ã®Catalystã®portã«lacpã®è¨­å®šã‚’å…¥ã‚Œã¦no shutã€‚

```
interface Port-channel2
 switchport mode trunk
!
interface GigabitEthernet0/1
 description kvm
 switchport mode trunk
 lacp rate fast
 channel-group 2 mode active
 no channel-group auto
!
interface GigabitEthernet0/2
 description kvm
 switchport mode trunk
 lacp rate fast
 channel-group 2 mode active
 no channel-group auto
```

ãã®å¾Œã€Fedoraã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯æœ€å°ã§OKã€‚
ã“ã®æ™‚ç‚¹ã§lacpã‚’çµ„ã‚“ã§ã‚‚è‰¯ã„ãŒã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œãªã„(å¾Œè¿°)ã®ã¨ã€ovsã®å ´åˆã“ã“ã§ä½œã‚‹è¨­å®šã¯ä¸è¦ã«ãªã‚‹ãŸã‚ã€ç‰‡ç³»ãŒã¨ã‚Šã‚ãˆãšç–é€šã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã‘ã°è‰¯ã„ã€‚

### å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
dnf update
dnf install -y qemu-kvm virt-manager virt-install openvswitch python-openvswitch NetworkManager-ovs
systemctl enable --now libvirtd
systemctl enable --now openvswitch
reboot
```

ãªãŠdnfã‹ã‚‰openvswitchã‚’å…¥ã‚Œã‚‹ã¨å¾®å¦™ã«å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå…¥ã‚‹ã®ã§ã€ãã‚ŒãŒæ°—ã«ãªã‚‹å ´åˆã¯[å…¬å¼doc](http://docs.openvswitch.org/en/latest/intro/install/fedora/)ã‚’å‚è€ƒã«è‡ªå‰buildã™ã‚‹ã€‚

ä»Šå›ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚å‹•ã„ãŸã®ã§ãƒ“ãƒ«ãƒ‰ã®æ‰‹é–“ã‚’çœã„ãŸğŸ˜‡ã€‚

### æ—¢å­˜ã®NetworkManagerã®connectionã‚’å…¨ã¦æ¶ˆã™

libvirtã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆNW(`virtbr0`)ã‚’æ¶ˆã™éš›ã¯`virsh`ã‹ã‚‰æ¶ˆã™ã“ã¨ã€‚

```bash
virsh net-delete default
virsh net-autostart default --disable
virsh net-undefine default
nmcli c del enp4s0
nmcli c del enp6s0
```

### ovsã®è¨­å®šã‚’å…¥ã‚Œã¦ã„ã

ovsã®ãƒªã‚½ãƒ¼ã‚¹ã¯vmwareã®esxiã¨ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

| ovs | esxi | å‚™è€ƒ|
| --- | --- | --- |
| Bridge|vSwitch | ä¸€ã¤ã®vlan domain |
| Port | PortGroup | è¤‡æ•°ã®ä»®æƒ³nicã‚’ã¾ã¨ã‚ã‚‹å˜ä½ã€‚Vlan Tagã¨ã‹ã¯ã“ã“ |
| Interface | Port | VM(Domain)ã¨ç›´æ¥ãã£ã¤ãå˜ä½ |

ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­è¨ˆã—ãŸã€‚

<Image width="523" height="592" alt="è©³ç´°è¨­è¨ˆ" src="/images/20200524_190651.png" />

libvirtã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã™ã‚‹å ´åˆã€**Bridgeã¨åŒåã®Port, Interfaceã‚’ç”¨æ„ã—ã¦Bridgeã¨åŒåã®Interfaceã‚’Linuxã«èªè­˜ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹**([ã‚½ãƒ¼ã‚¹](https://libvirt.org/formatnetwork.html#elementsConnect))ã€‚

ä»Šå›ã®å ´åˆã ã¨`ext`ã¨ã„ã†Bridgeåãªã®ã§ã€`ext`ã¨ã„ã†åå‰ã®Portã¨Interfaceã‚’ä½œã‚Œã°è‰¯ã„ã€‚

libvirtã¯åŒåInterfaceã‹ã‚‰mtuã®å€¤ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã®ã§ã€è©²å½“InterfaceãŒå­˜åœ¨ã—ãªã„ã¨`libvirt: Cannot get interface MTU`ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ã‚’åãã€‚

ãªãŠè©²å½“ã®Interfaceã«mtuãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯domainã®nicã®mtuã«1500ãŒè¨­å®šã•ã‚Œã‚‹(~~ãã‚Œãªã‚‰ã‚ã–ã‚ã–Interfaceã®å­˜åœ¨ã‚’å¿…é ˆã«ã—ãªãã¦ã‚‚è‰¯ã„ã®ã§ã¯ã¨ã‹æ€ã£ã¡ã‚ƒã†~~)ã€‚

```bash
# Bridgeã®ä½œæˆ
nmcli c a con-name ext type ovs-bridge conn.interface ext
# lacpã‚’æœ‰åŠ¹ã«ã—ãŸbond Portã®ä½œæˆ(vlanã¯trunk)
nmcli c a con-name uplink type ovs-port conn.interface uplink master ext ovs-port.lacp active ovs-port.vlan-mode trunk
# bondPortã«ç‰©ç†NICã‚’ç´ã¥ã‘(ã“ã‚ŒãŒçµ‚ã‚ã‚‹ã¨å¯¾å‘SWã¨ã®linkãŒä¸ŠãŒã‚‹)
nmcli c a con-name enp4s0 type ethernet conn.interface enp4s0 master uplink
nmcli c a con-name enp6s0 type ethernet conn.interface enp6s0 master uplink
# ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆç”¨Portã‚’ä½œæˆ
nmcli c a con-name vlan20 type ovs-port conn.interface vlan20 master ovsbr0 ovs-port.tag 20
# ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆç”¨Portã«Interfaceã‚’ä½œæˆã—ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®š(ã“ã‚ŒãŒçµ‚ã‚ã‚‹ã¨sshã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹(æ™‚ã‚‚ã‚ã‚‹)
nmcli c a con-name veth20 type ovs-interface slave-type ovs-port conn.interface veth20 master vlan20 ipv4.method manual ipv4.address 192.168.20.2/24 ipv4.gateway 192.168.20.1 ipv4.dns 192.168.0.1
# libvirtç”¨ã«åŒåPortåŠã³åŒåInterfaceã‚’ä½œæˆ(con-nameã‚’é©åˆ‡ã«å¤‰æ›´ã—ãªã„ã¨Warningå‡ºã‚‹)
nmcli c a con-name extpg type ovs-port conn.interface ext master ext
nmcli c a con-name extint type ovs-interface slave-type ovs-port conn.interface ext master extpg
systemctl restart NetworkManager.service
```

ã“ã‚Œã‚‰ãŒå…¨ã¦çµ‚ã‚ã£ãŸå¾Œã€å¤–éƒ¨ã¨ç–é€šã™ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚æ™‚ã€…ç–é€šã—ãªã‹ã£ãŸã‚Šã™ã‚‹ã®ã§ãã®ã¨ãã¯å†èµ·å‹•ã€‚

ovsã«è¨­å®šãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚

```bash
[root@kvm ~]# ovs-vsctl show
8e228eec-22c1-4012-afaf-1f5ee89aa38c
    Bridge ext
        Port ext
            Interface ext
                type: internal
        Port "vlan20"
            tag: 20
            Interface "veth20"
                type: internal
        Port uplink
            Interface "enp6s0"
                type: system
            Interface "enp4s0"
                type: system
    ovs_version: "2.12.0"
```

### libvirtã®è¨­å®šã‚’ä½œã‚‹

ã‚³ã‚³ã‚‰ã¸ã‚“ã¯å…¬å¼docã‚’è¦‹ã¤ã¤åŸ‹ã‚ã¦ã„ãã€‚

```xml
<network>
  <name>ext</name>
  <forward mode='bridge'/>
  <bridge name='ext'/>
  <virtualport type='openvswitch'/>
  <portgroup name='untag' default='yes'>
  </portgroup>
  <portgroup name='vlan21'>
    <vlan>
      <tag id='21'/>
    </vlan>
  </portgroup>
</network>
```

```bash
virsh net-define ext.xml
virsh net-start ext
virsh net-autostart ext
```

### domainãŒèµ·å‹•ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

virshã§ã‚‚virt-managerã‹ã‚‰ã§ã‚‚ãŠå¥½ã¿ã§ã€‚

`untag`ã®nicã‚’é¸ã¶ã¨vlan tagãŒè¨­å®šã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã«ãªã‚‹ã®ã§

```bash
nmcli c a type vlan con-name vlan21 ifname enp4s0.21 dev enp4s0 id 21 ipv4.method manual ipv4.address 192.168.21.2/24 ipv4.gateway 192.168.21.1
```

ã¿ãŸã„ãªæ„Ÿã˜ã§vlan intefaceã‚’å®šç¾©ã™ã‚Œã°OKã€‚

## æ³¨æ„ç‚¹

å¤šåˆ†ãƒãƒã‚Šã©ã“ã‚ã¯Bridge, Port, Interfaceå…¨ã¦ã«åŒåã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ãªã„ã¨ã„ã‘ãªã„ã¨ã“ã‚ã€‚

ä½¿ã‚ãªã„InterfaceãŒä¸¸è¦‹ãˆãªã®ã¯ã¡ã‚‡ã£ã¨æ°—æŒã¡æ‚ªã„ãŒã€ã“ã“ã‚‰ã¸ã‚“ã¯å¦¥å”ãƒ©ã‚¤ãƒ³ã‹ãªã€‚

## NetworkManager-ovsã‚’ä½¿ã†æ„å‘³

ã‚ã¾ã‚Šãªã„ã€‚å¼·ã„ã¦è¨€ã†ãªã‚‰Networkã®å¤‰æ›´ã‚’ä¸€å…ƒåŒ–ã§ãã‚‹ã‹ãªãã‚‰ã„ã€‚ã—ã‹ã—ä»®ã«NetworkManagerã‚’ä½¿ã‚ãªã„å ´åˆã€`/etc/sysconfig/network-scripts`ã«ã²ãŸã™ã‚‰è¨­å®šã‚’æ›¸ã„ã¦ã„ãã“ã¨ã«ãªã‚‹ã®ã§ãã‚Œã¯ãã‚Œã§ã©ã†ãªã®ï¼Ÿã¨ã„ã†æ°—æŒã¡ã«ãªã‚‹ã€‚

ãªãŠã€NetworkManagerã‚’çµŒç”±ã™ã‚‹å ´åˆã€ä¸€éƒ¨æœªå®Ÿè£…ã®æ©Ÿèƒ½(mtuè¨­å®š, vlan trunkã®ç¯„å›²æŒ‡å®šç­‰)ãŒã‚ã‚‹ã€‚ãã®ãŸã‚ã€è¨­å®šã‚’çªãè©°ã‚ã‚‹å ´åˆã¯NetworkManagerã‚’çµŒç”±ã—ãªã„ã»ã†ãŒè‰¯ã„ã€‚


## å‚è€ƒæ–‡çŒ®

- [CentOS7 ovs(Open vSwitch)ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šæ–¹æ³•](https://metonymical.hatenablog.com/entry/2018/12/25/210811)
- [nm-openvswitch](https://developer.gnome.org/NetworkManager/stable/nm-openvswitch.html)
- [libvirt](https://libvirt.org/formatnetwork.html)
- [libnm-core](https://gitlab.freedesktop.org/NetworkManager/NetworkManager/-/tree/master/libnm-core)

## ãã®ä»–

ä½œå›³ã«ã¯[miro](https://miro.com)ã‚’ä½¿ã„ã¾ã—ãŸã€‚

export default ({ children }) => <Layout meta={meta}>{children}</Layout>
